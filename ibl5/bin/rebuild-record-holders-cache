#!/usr/bin/env php
<?php

declare(strict_types=1);

if (php_sapi_name() !== 'cli') {
    http_response_code(403);
    exit('This script must be run from the command line.');
}

set_time_limit(0);

$_SERVER['DOCUMENT_ROOT'] = dirname(__DIR__, 2);
$_SERVER['SERVER_NAME'] = in_array('--production', $argv, true) ? 'iblhoops.net' : 'localhost';
require $_SERVER['DOCUMENT_ROOT'] . '/ibl5/vendor/autoload.php';
include $_SERVER['DOCUMENT_ROOT'] . '/ibl5/config.php';
include $_SERVER['DOCUMENT_ROOT'] . '/ibl5/db/db.php';

/** @var \mysqli $mysqli_db */

echo "Record Holders cache rebuild started\n";

// --- Detect broken/tied records for new game dates ---

$recordHoldersRepository = new \RecordHolders\RecordHoldersRepository($mysqli_db);
$lastAnnouncedDate = $recordHoldersRepository->getLastAnnouncedDate();
$newDates = $recordHoldersRepository->getUnannouncedGameDates($lastAnnouncedDate);

if ($newDates !== []) {
    $latestDate = $newDates[count($newDates) - 1];
    echo 'Checking ' . count($newDates) . ' game date(s) for records (' . $newDates[0] . ' to ' . $latestDate . ")\n";

    $detector = new \RecordHolders\RecordBreakingDetector($recordHoldersRepository);
    $announcements = $detector->detectAndAnnounce($newDates);

    if ($announcements !== []) {
        foreach ($announcements as $msg) {
            echo "  RECORD: {$msg}\n";
        }
    } else {
        echo "  No records broken or tied\n";
    }

    $recordHoldersRepository->markAnnouncementsProcessed($latestDate);
} else {
    echo "No new game dates to check\n";
}

// --- Rebuild the cache atomically ---

echo "Rebuilding cache...\n";

$innerService = new \RecordHolders\RecordHoldersService($recordHoldersRepository);
$cachedService = new \RecordHolders\CachedRecordHoldersService($innerService, $mysqli_db);
$cachedService->rebuildCache();

echo "Cache rebuilt successfully\n";
