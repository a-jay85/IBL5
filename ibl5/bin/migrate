#!/usr/bin/env php
<?php

declare(strict_types=1);

if (php_sapi_name() !== 'cli') {
    http_response_code(403);
    exit('This script must be run from the command line.');
}

set_time_limit(0);

$_SERVER['DOCUMENT_ROOT'] = dirname(__DIR__, 2);
require $_SERVER['DOCUMENT_ROOT'] . '/ibl5/vendor/autoload.php';
include $_SERVER['DOCUMENT_ROOT'] . '/ibl5/config.php';
include $_SERVER['DOCUMENT_ROOT'] . '/ibl5/db/db.php';

/** @var \mysqli $mysqli_db */

$migrationsDir = dirname(__DIR__) . '/migrations';
$repository = new \Migration\MigrationRepository($mysqli_db);
$fileResolver = new \Migration\MigrationFileResolver($migrationsDir);
$runner = new \Migration\MigrationRunner($repository, $fileResolver);

// --status flag: list pending migrations and exit
if (in_array('--status', $argv, true)) {
    $pending = $runner->getPending();

    if ($pending === []) {
        echo "Nothing to migrate.\n";
        exit(0);
    }

    echo count($pending) . " pending migration(s):\n";
    foreach ($pending as $filename) {
        echo "  - {$filename}\n";
    }
    exit(0);
}

// Default: run all pending migrations
try {
    $pending = $runner->getPending();

    if ($pending === []) {
        echo "Nothing to migrate.\n";
        exit(0);
    }

    echo count($pending) . " pending migration(s) to run...\n";

    $executed = $runner->runPending();

    echo "Successfully ran " . count($executed) . " migration(s):\n";
    foreach ($executed as $filename) {
        echo "  - {$filename}\n";
    }
    exit(0);
} catch (\RuntimeException $e) {
    echo "Migration failed: " . $e->getMessage() . "\n";
    exit(1);
}
