name: Build and Deploy
on:
  push:
    branches:
      - production
jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: rm -f package-lock.json && npm install
        working-directory: ibl5

      - name: Build CSS
        run: npx @tailwindcss/cli -i design/input.css -o themes/IBL/style/style.css --minify
        working-directory: ibl5

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          ssh-keyscan -p ${{ secrets.PORT }} ${{ secrets.HOST }} >> ~/.ssh/known_hosts 2>/dev/null
        env:
          DEPLOY_KEY: ${{ secrets.PRIVATE_KEY }}

      - name: Pull latest code on server
        run: ssh -p ${{ secrets.PORT }} -i ~/.ssh/id_deploy ${{ secrets.USERNAME }}@${{ secrets.HOST }} "cd www && git pull origin"

      - name: Deploy compiled CSS to server
        run: scp -P ${{ secrets.PORT }} -i ~/.ssh/id_deploy ibl5/themes/IBL/style/style.css ${{ secrets.USERNAME }}@${{ secrets.HOST }}:www/ibl5/themes/IBL/style/style.css

      - name: Check for IBLbot changes
        id: iblbot-changes
        run: |
          if git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep -qE '^(ibl5/IBLbot/|\.github/workflows/main\.yml)'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy and restart IBLbot
        if: steps.iblbot-changes.outputs.changed == 'true'
        run: |
          ssh -p ${{ secrets.PORT }} -i ~/.ssh/id_deploy ${{ secrets.USERNAME }}@${{ secrets.HOST }} '
            set -e
            cd www/ibl5/IBLbot

            echo "Installing dependencies..."
            npm install --include=dev

            echo "Building TypeScript..."
            npm run build

            echo "Registering slash commands..."
            npm run deploy-commands

            echo "Stopping old bot process..."
            if [ -f bot.pid ] && kill -0 "$(cat bot.pid)" 2>/dev/null; then
              kill "$(cat bot.pid)"
              sleep 2
            fi

            echo "Starting new bot process..."
            mkdir -p logs
            setsid node dist/index.js > logs/bot.log 2>&1 < /dev/null &
            echo $! > bot.pid
            sleep 1

            echo "IBLbot deployed successfully (PID: $(cat bot.pid))"
          '

      - name: Check for IBL6 changes
        id: ibl6-changes
        run: |
          if git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep -qE '^(IBL6/|\.github/workflows/main\.yml)'; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build IBL6
        if: steps.ibl6-changes.outputs.changed == 'true'
        run: npm ci && npm run build
        working-directory: IBL6

      - name: Deploy IBL6 build to server
        if: steps.ibl6-changes.outputs.changed == 'true'
        run: |
          ssh -p ${{ secrets.PORT }} -i ~/.ssh/id_deploy ${{ secrets.USERNAME }}@${{ secrets.HOST }} 'rm -rf www/IBL6/build'
          scp -r -P ${{ secrets.PORT }} -i ~/.ssh/id_deploy IBL6/build ${{ secrets.USERNAME }}@${{ secrets.HOST }}:www/IBL6/

      - name: Install deps and restart IBL6
        if: steps.ibl6-changes.outputs.changed == 'true'
        run: |
          ssh -p ${{ secrets.PORT }} -i ~/.ssh/id_deploy ${{ secrets.USERNAME }}@${{ secrets.HOST }} '
            set -e
            cd www/IBL6

            echo "Installing production dependencies..."
            npm ci --omit=dev

            echo "Generating Prisma client..."
            npx prisma generate

            echo "Stopping old IBL6 process..."
            if [ -f ibl6.pid ] && kill -0 "$(cat ibl6.pid)" 2>/dev/null; then
              kill "$(cat ibl6.pid)"
              sleep 2
            fi

            echo "Starting IBL6..."
            mkdir -p logs
            setsid env PORT=3001 node build/index.js > logs/ibl6.log 2>&1 < /dev/null &
            echo $! > ibl6.pid
            sleep 1

            echo "IBL6 deployed successfully (PID: $(cat ibl6.pid))"
          '
